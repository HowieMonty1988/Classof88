<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Class of 88, Story Recorder</title>

<style>
  body{
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 22px;
    max-width: 900px;
    background-color: #faf6f0;
    color: #222;
  }
  .wrap{ max-width: 820px; margin: 0 auto; }
  h1{ margin: 0 0 10px; font-size: 26px; }
  .intro{
    background: #fff; border: 1px solid #e2d9cc; border-radius: 12px;
    padding: 18px; margin-bottom: 18px; line-height: 1.6;
  }
  .card{
    background: #fff; border: 1px solid #e2d9cc; border-radius: 12px; padding: 18px;
  }
  label{ display: block; font-weight: bold; margin-top: 12px; }
  input, textarea{
    width: 100%; padding: 10px; border-radius: 10px;
    border: 1px solid #ccc; margin-top: 4px; font-size: 14px;
  }
  textarea{ resize: vertical; }
  .row{ display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }
  button{
    padding: 10px 16px; border-radius: 10px; border: 1px solid #333;
    background: #333; color: #fff; cursor: pointer; font-size: 14px;
  }
  button.secondary{ background: #fff; color: #333; }
  button:disabled{ opacity: 0.55; cursor: not-allowed; }
  .status{
    margin-top: 12px; font-weight: bold; display: flex; gap: 14px; align-items: baseline; flex-wrap: wrap;
  }
  .muted{ font-weight: normal; color: #555; }
  .timer{ font-variant-numeric: tabular-nums; font-weight: bold; }
  .rec{
    padding: 2px 8px; border-radius: 999px; font-size: 12px;
    border: 1px solid #a33; color: #a33; background: #fff;
  }
  .rec.on{ background: #a33; color: #fff; }
  .note{ font-size: 13px; color: #555; margin-top: 10px; line-height: 1.5; }
  audio{ width: 100%; margin-top: 14px; }
</style>
</head>

<body>
<div class="wrap">

<h1>Class of 88, Story Recorder</h1>

<div class="intro">
  <p>This page collects spoken stories from our high school years. No writing required.</p>
  <p>Please start by saying your name and graduation year.</p>
</div>

<div class="card">
  <label>Your name</label>
  <input id="name" placeholder="Example: Steve Hauer">

  <label>Graduation year (optional)</label>
  <input id="year" placeholder="1988">

  <label>Email (optional)</label>
  <input id="email">

  <label>Phone (optional)</label>
  <input id="phone">

  <label>Story subject</label>
  <textarea id="subject" rows="3"></textarea>

  <div class="row">
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="submitBtn" class="secondary" disabled>Submit</button>
    <button id="resetBtn" class="secondary" disabled>Reset</button>
  </div>

  <div class="status">
    <div>Status: <span class="muted" id="statusText">Ready</span></div>
    <div>Time: <span class="timer" id="timer">00:00</span></div>
    <div><span class="rec" id="recBadge">RECORDING</span></div>
  </div>

  <audio id="playback" controls></audio>
  <p class="note">Submitting sends the recording directly to the project Drive folder.</p>
</div>

</div>

<script>
const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbyo5vUFD3HrCqeW9N20keNf0C3468GRL20nrGEM_3hJWAvv-1whGIwGhdCXjmQ-TsWy/exec

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const submitBtn = document.getElementById("submitBtn");
const resetBtn = document.getElementById("resetBtn");
const statusText = document.getElementById("statusText");
const timerEl = document.getElementById("timer");
const recBadge = document.getElementById("recBadge");
const playback = document.getElementById("playback");

let mediaRecorder, chunks=[], audioBlob, startTime, raf;

function format(sec){
  return String(Math.floor(sec/60)).padStart(2,"0")+":"+String(sec%60).padStart(2,"0");
}
function tick(){
  timerEl.textContent = format(Math.floor((Date.now()-startTime)/1000));
  raf = requestAnimationFrame(tick);
}
function resetTimer(){
  cancelAnimationFrame(raf); timerEl.textContent="00:00";
}

startBtn.onclick = async ()=>{
  chunks=[];
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=()=>{
    audioBlob=new Blob(chunks,{type:"audio/webm"});
    playback.src=URL.createObjectURL(audioBlob);
    submitBtn.disabled=false; resetBtn.disabled=false;
    recBadge.classList.remove("on"); cancelAnimationFrame(raf);
    stream.getTracks().forEach(t=>t.stop());
  };
  mediaRecorder.start();
  startTime=Date.now(); resetTimer(); tick();
  recBadge.classList.add("on");
  startBtn.disabled=true; stopBtn.disabled=false;
  statusText.textContent="Recording";
};

stopBtn.onclick=()=>{
  mediaRecorder.stop();
  startBtn.disabled=false; stopBtn.disabled=true;
  statusText.textContent="Ready to submit";
};

submitBtn.onclick=async()=>{
  statusText.textContent="Uploading...";
  const reader=new FileReader();
  reader.onloadend=async()=>{
    const res = await fetch(UPLOAD_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        filename:"Classof88_"+Date.now()+".webm",
        mimeType:"audio/webm",
        data:reader.result.split(",")[1],
        name:name.value, year:year.value,
        email:email.value, phone:phone.value, subject:subject.value
      })
    });
    const json = await res.json();
    if(json.ok){
      statusText.textContent="Submitted successfully";
    }else{
      statusText.textContent="Upload failed";
      alert(json.error || "Upload failed");
    }
  };
  reader.readAsDataURL(audioBlob);
};

resetBtn.onclick=()=>location.reload();
</script>
</body>
</html>
