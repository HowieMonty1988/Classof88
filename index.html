<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>High School Stories Recorder</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: Arial, sans-serif; margin: 24px; background:#f6f7fb; }
    h1 { margin: 0 0 12px; }
    .note { background:#fff3cd; border:1px solid #ffeeba; padding:12px; border-radius:10px; max-width: 860px; }
    .card { background:#fff; border:1px solid #e6e6e6; border-radius:14px; padding:18px; max-width: 860px; margin-top: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    label { display:block; font-weight:700; margin: 12px 0 6px; }
    input, textarea { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #cfd4dc; border-radius:10px; font-size: 14px; }
    textarea { min-height: 88px; resize: vertical; }
    .row { display:flex; gap:12px; }
    .row > div { flex: 1; }
    .buttons { display:flex; gap:10px; margin-top: 14px; flex-wrap: wrap; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #cfd4dc; background:#111; color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:#111; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .status { margin-top: 10px; font-weight:700; }
    .muted { font-weight:400; color:#555; }
    audio { width:100%; margin-top: 10px; }
    .small { font-size: 12px; color:#555; margin-top: 10px; line-height: 1.35; }
    .ok { color: #0a7a2f; }
    .bad { color: #b00020; }
    .divider { height:1px; background:#ececec; margin: 16px 0; }
  </style>
</head>
<body>
  <h1>High School Stories Recorder</h1>

  <div class="note">
    <b>Instructions.</b> Fill in your info, press <b>Start Recording</b>, tell your story, then press <b>Stop</b>. Finally press <b>Submit Recording</b>.
    <div class="small">
      Privacy option. If you want your story kept private and not used in a book, say that clearly at the start of your recording.<br>
      Time note. Long recordings can fail if your phone sleeps. Keep the screen awake. If you have a long story, do it in 5 to 10 minute parts.
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label for="name">Your name</label>
        <input id="name" type="text" placeholder="Example: Steve Hauer" autocomplete="name" />
      </div>
      <div>
        <label for="year">Graduation year (optional)</label>
        <input id="year" type="text" placeholder="Example: 1988" inputmode="numeric" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="email">Email (optional)</label>
        <input id="email" type="email" placeholder="Example: you@email.com" autocomplete="email" />
      </div>
      <div>
        <label for="phone">Phone (optional)</label>
        <input id="phone" type="tel" placeholder="Example: 320-555-1234" autocomplete="tel" />
      </div>
    </div>

    <label for="subject">Story subject or quick description</label>
    <textarea id="subject" placeholder="Example: The time we got kicked out of the gym after the pep fest"></textarea>

    <div class="divider"></div>

    <div class="buttons">
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" class="secondary" disabled>Stop</button>
      <button id="submitBtn" class="secondary" disabled>Submit Recording</button>
      <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <div class="status" id="status">
      Status: <span class="muted" id="statusText">Ready</span>
      <span style="margin-left:12px;">Time: <span id="time">00:00</span></span>
    </div>

    <audio id="player" controls></audio>

    <div class="small">
      Best browser. Chrome or Edge on desktop or Android. iPhone Safari can be inconsistent for long recordings.
    </div>
  </div>

<script>
  "use strict";

  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyo5vUFD3HrCqeW9N20keNf0C3468GRL20nrGEM_3hJWAvv-1whGIwGhdCXjmQ-TsWy/exec";

  const els = {
    name: document.getElementById("name"),
    year: document.getElementById("year"),
    email: document.getElementById("email"),
    phone: document.getElementById("phone"),
    subject: document.getElementById("subject"),
    startBtn: document.getElementById("startBtn"),
    stopBtn: document.getElementById("stopBtn"),
    submitBtn: document.getElementById("submitBtn"),
    resetBtn: document.getElementById("resetBtn"),
    statusText: document.getElementById("statusText"),
    time: document.getElementById("time"),
    player: document.getElementById("player"),
  };

  let mediaRecorder = null;
  let chunks = [];
  let recordingBlob = null;

  let timerId = null;
  let startTs = 0;

  function setStatus(text, kind) {
    els.statusText.textContent = text;
    els.statusText.className = "muted";
    if (kind === "ok") els.statusText.className = "ok";
    if (kind === "bad") els.statusText.className = "bad";
  }

  function mmss(totalSeconds) {
    const m = Math.floor(totalSeconds / 60);
    const s = Math.floor(totalSeconds % 60);
    const mm = String(m).padStart(2, "0");
    const ss = String(s).padStart(2, "0");
    return mm + ":" + ss;
  }

  function startTimer() {
    stopTimer();
    startTs = Date.now();
    els.time.textContent = "00:00";
    timerId = setInterval(() => {
      const sec = Math.floor((Date.now() - startTs) / 1000);
      els.time.textContent = mmss(sec);
    }, 250);
  }

  function stopTimer() {
    if (timerId) clearInterval(timerId);
    timerId = null;
  }

  async function startRecording() {
    recordingBlob = null;
    chunks = [];

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setStatus("This browser cannot access the microphone.", "bad");
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      let options = {};
      if (MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) {
        options.mimeType = "audio/webm;codecs=opus";
      } else if (MediaRecorder.isTypeSupported("audio/webm")) {
        options.mimeType = "audio/webm";
      }

      mediaRecorder = new MediaRecorder(stream, options);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const mime = mediaRecorder.mimeType || "audio/webm";
        recordingBlob = new Blob(chunks, { type: mime });
        els.player.src = URL.createObjectURL(recordingBlob);
        els.submitBtn.disabled = !recordingBlob;
        setStatus("Recording stopped. Ready to submit.", "ok");
      };

      mediaRecorder.start(250);
      startTimer();

      els.startBtn.disabled = true;
      els.stopBtn.disabled = false;
      els.submitBtn.disabled = true;

      setStatus("Recording...", "ok");
    } catch (err) {
      setStatus("Mic blocked. Click the lock icon and allow Microphone.", "bad");
    }
  }

  function stopRecording() {
    if (!mediaRecorder) return;

    try {
      mediaRecorder.stop();
      stopTimer();

      els.stopBtn.disabled = true;
      els.startBtn.disabled = false;
      setStatus("Stopping...", "ok");
    } catch (e) {
      setStatus("Could not stop recording.", "bad");
    }
  }

  function fileNameSafe(s) {
    return String(s || "")
      .trim()
      .replace(/[^\w\s.-]/g, "")
      .replace(/\s+/g, "_")
      .slice(0, 60);
  }

  function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = reject;
      reader.onload = () => {
        const dataUrl = reader.result;
        const base64 = String(dataUrl).split(",")[1] || "";
        resolve(base64);
      };
      reader.readAsDataURL(blob);
    });
  }

  async function submitRecording() {
    if (!recordingBlob) {
      setStatus("No recording to submit.", "bad");
      return;
    }

    els.submitBtn.disabled = true;
    setStatus("Submitting to Drive...", "ok");

    const name = els.name.value.trim();
    const year = els.year.value.trim();
    const email = els.email.value.trim();
    const phone = els.phone.value.trim();
    const subject = els.subject.value.trim();

    const baseName = fileNameSafe(name || "Unknown");
    const ts = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `ClassOf88_${baseName}_${ts}.webm`;

    try {
      const base64 = await blobToBase64(recordingBlob);

      const payload = {
        filename,
        mimeType: recordingBlob.type || "audio/webm",
        data: base64,
        name,
        year,
        email,
        phone,
        subject
      };

      const res = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error("Submit failed: " + res.status + " " + text);
      }

      const json = await res.json();
      if (!json || json.ok !== true) {
        throw new Error("Submit error: " + (json && json.error ? json.error : "Unknown"));
      }

      setStatus("Submitted. Saved to Drive.", "ok");
    } catch (err) {
      setStatus(String(err && err.message ? err.message : err), "bad");
      els.submitBtn.disabled = false;
    }
  }

  function resetAll() {
    stopTimer();
    chunks = [];
    recordingBlob = null;
    els.player.removeAttribute("src");
    els.player.load();
    els.time.textContent = "00:00";
    els.startBtn.disabled = false;
    els.stopBtn.disabled = true;
    els.submitBtn.disabled = true;
    setStatus("Ready", null);
  }

  els.startBtn.addEventListener("click", startRecording);
  els.stopBtn.addEventListener("click", stopRecording);
  els.submitBtn.addEventListener("click", submitRecording);
  els.resetBtn.addEventListener("click", resetAll);

  resetAll();
</script>
</body>
</html>
