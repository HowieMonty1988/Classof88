<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>High School Stories Recorder</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; max-width: 820px; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    p { line-height: 1.5; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-top: 14px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #111;
      background: #111;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    button.secondary { background: #fff; color: #111; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    label { display: block; font-weight: bold; margin-top: 12px; }
    input[type="text"], input[type="email"], input[type="tel"] {
      width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc;
    }
    .status { margin-top: 10px; font-weight: bold; }
    .muted { color: #444; font-weight: normal; }
    audio { width: 100%; margin-top: 12px; }
    .warn { background: #fff7e6; border: 1px solid #ffd59a; padding: 10px; border-radius: 10px; }
    .small { font-size: 13px; }
    .timer { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <h1>High School Stories Recorder</h1>

  <p class="warn small">
    Instructions. Enter your name and optional contact info, press Start Recording, tell your story, then press Stop and Download.
    If you want your story kept private and not used in a book, say that clearly at the start of your recording.
    Contact info is only used if clarification is needed.
  </p>

  <div class="card">
    <label for="name">Your name</label>
    <input id="name" type="text" placeholder="Example: Steve Hauer" autocomplete="name" />

    <label for="year">Graduation year (optional)</label>
    <input id="year" type="text" placeholder="Example: 1995" inputmode="numeric" />

    <label for="email">Email address (optional)</label>
    <input id="email" type="email" placeholder="Example: you@email.com" autocomplete="email" />

    <label for="phone">Phone number (optional)</label>
    <input id="phone" type="tel" placeholder="Example: 555-123-4567" autocomplete="tel" />

    <div class="row">
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="downloadBtn" class="secondary" disabled>Download Recording</button>
      <button id="resetBtn" class="secondary" disabled>Reset</button>
    </div>

    <div class="status" id="status">
      Status: <span class="muted">Ready</span>
      <span style="margin-left:12px;">Time: <span class="timer" id="timer">00:00</span></span>
    </div>

    <audio id="playback" controls></audio>

    <p class="small muted">
      Use Chrome or Edge if possible. Keep your screen awake while recording.
    </p>
  </div>

  <script>
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusEl = document.getElementById("status");
    const timerEl = document.getElementById("timer");
    const playback = document.getElementById("playback");
    const nameEl = document.getElementById("name");
    const yearEl = document.getElementById("year");
    const emailEl = document.getElementById("email");
    const phoneEl = document.getElementById("phone");

    let mediaRecorder = null;
    let chunks = [];
    let audioBlob = null;
    let audioUrl = null;
    let timerInterval = null;
    let startTimeMs = 0;

    function setStatus(text) {
      statusEl.innerHTML = `Status: <span class="muted">${text}</span>
        <span style="margin-left:12px;">Time: <span class="timer" id="timer">${timerEl.textContent}</span></span>`;
      const newTimerEl = document.getElementById("timer");
      timerEl.textContent = newTimerEl.textContent;
    }

    function formatTime(totalSeconds) {
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }

    function startTimer() {
      startTimeMs = Date.now();
      timerEl.textContent = "00:00";
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTimeMs) / 1000);
        timerEl.textContent = formatTime(elapsed);
      }, 250);
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }

    function safeFilename() {
      const name = (nameEl.value || "Anonymous").trim().replace(/[^a-z0-9]+/gi, "_");
      const year = (yearEl.value || "").trim().replace(/[^0-9]+/g, "");
      const email = (emailEl.value || "").trim().replace(/[^a-z0-9]+/gi, "_");
      const phone = (phoneEl.value || "").trim().replace(/[^0-9]+/g, "");
      const stamp = new Date().toISOString().replace(/[:.]/g, "").slice(0, 15);

      const parts = ["HighSchoolStory", name];
      if (year) parts.push(year);
      if (email) parts.push("email_" + email);
      if (phone) parts.push("phone_" + phone);
      parts.push(stamp);
      return parts.join("_");
    }

    function cleanupUrl() {
      if (audioUrl) URL.revokeObjectURL(audioUrl);
      audioUrl = null;
    }

    function resetAll() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        try { mediaRecorder.stop(); } catch (e) {}
      }
      mediaRecorder = null;
      chunks = [];
      audioBlob = null;
      cleanupUrl();
      playback.src = "";
      downloadBtn.disabled = true;
      resetBtn.disabled = true;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      stopTimer();
      timerEl.textContent = "00:00";
      setStatus("Ready");
    }

    async function getSupportedMimeType() {
      const candidates = [
        "audio/webm;codecs=opus",
        "audio/webm",
        "audio/ogg;codecs=opus",
        "audio/ogg"
      ];
      for (const t of candidates) {
        if (MediaRecorder.isTypeSupported(t)) return t;
      }
      return "";
    }

    startBtn.addEventListener("click", async () => {
      try {
        resetAll();
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("This browser does not support microphone recording.");
          return;
        }

        const mimeType = await getSupportedMimeType();
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });

        chunks = [];
        audioBlob = null;

        mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
        mediaRecorder.ondataavailable = (e) => { if (e.data && e.data.size > 0) chunks.push(e.data); };
        mediaRecorder.onstop = () => {
          stopTimer();
          setStatus("Processing recording");
          audioBlob = new Blob(chunks, { type: mediaRecorder.mimeType || "audio/webm" });
          cleanupUrl();
          audioUrl = URL.createObjectURL(audioBlob);
          playback.src = audioUrl;
          downloadBtn.disabled = false;
          resetBtn.disabled = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;
          setStatus("Ready to download");
          stream.getTracks().forEach(t => t.stop());
        };

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        downloadBtn.disabled = true;
        resetBtn.disabled = false;
        setStatus("Recording");
        startTimer();
      } catch (err) {
        alert("Microphone access failed. Allow mic permissions and try again.");
        resetAll();
      }
    });

    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        setStatus("Stopping");
        mediaRecorder.stop();
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!audioBlob) return;
      const ext = (audioBlob.type && audioBlob.type.includes("ogg")) ? "ogg" : "webm";
      const filename = safeFilename() + "." + ext;
      const a = document.createElement("a");
      a.href = audioUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    resetBtn.addEventListener("click", resetAll);
    window.addEventListener("beforeunload", cleanupUrl);
  </script>
</body>
</html>
