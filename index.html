<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Class of 88, Story Recorder</title>

<style>
  body{
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 22px;
    max-width: 900px;
    background-color: #faf6f0;
    color: #222;
  }

  .wrap{
    max-width: 820px;
    margin: 0 auto;
  }

  h1{
    margin: 0 0 10px;
    font-size: 26px;
  }

  .intro{
    background: #ffffff;
    border: 1px solid #e2d9cc;
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 18px;
    line-height: 1.6;
  }

  .card{
    background: #ffffff;
    border: 1px solid #e2d9cc;
    border-radius: 12px;
    padding: 18px;
  }

  label{
    display: block;
    font-weight: bold;
    margin-top: 12px;
  }

  input, textarea{
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    margin-top: 4px;
    font-size: 14px;
  }

  textarea{
    resize: vertical;
  }

  .row{
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 16px;
  }

  button{
    padding: 10px 16px;
    border-radius: 10px;
    border: 1px solid #333;
    background: #333;
    color: #fff;
    cursor: pointer;
    font-size: 14px;
  }

  button.secondary{
    background: #ffffff;
    color: #333;
  }

  button:disabled{
    opacity: 0.55;
    cursor: not-allowed;
  }

  .status{
    margin-top: 12px;
    font-weight: bold;
  }

  .muted{
    font-weight: normal;
    color: #555;
  }

  .note{
    font-size: 13px;
    color: #555;
    margin-top: 10px;
    line-height: 1.5;
  }

  audio{
    width: 100%;
    margin-top: 14px;
  }
</style>
</head>

<body>
<div class="wrap">

  <h1>Class of 88, Story Recorder</h1>

  <div class="intro">
    <p>
      This page collects real stories and memories from our high school years. No writing required. Press Start Recording and speak naturally.
    </p>
    <p>
      Please begin your recording by saying your name and graduation year. If there is anything you do not want included in a future book, say that clearly at the start of your recording.
    </p>
    <p class="note">
      Tip. Chrome or Edge works best. Keep your screen awake while recording and submitting.
    </p>
  </div>

  <div class="card">
    <label for="name">Your name</label>
    <input id="name" type="text" placeholder="Example: Steve Hauer" autocomplete="name" />

    <label for="year">Graduation year (optional)</label>
    <input id="year" type="text" placeholder="Example: 1988" inputmode="numeric" />

    <label for="email">Email (optional)</label>
    <input id="email" type="email" placeholder="Example: name@email.com" autocomplete="email" />

    <label for="phone">Phone number (optional)</label>
    <input id="phone" type="tel" placeholder="Example: 555-123-4567" autocomplete="tel" />

    <label for="subject">Story subject or short description</label>
    <textarea id="subject" rows="3" placeholder="Example: Football bus trip, first car, weekend hangouts."></textarea>

    <div class="row">
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop</button>
      <button id="submitBtn" class="secondary" disabled>Submit Recording</button>
      <button id="resetBtn" class="secondary" disabled>Reset</button>
    </div>

    <div class="status" id="status">
      Status: <span class="muted" id="statusText">Ready</span>
    </div>

    <audio id="playback" controls></audio>

    <p class="note">
      You do not need to download anything. Submitting sends your recording to the project Drive folder.
    </p>
  </div>

</div>

<script>
  const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxsSrMHR2D97u5cnr8SPzHgjnvxbqwWryIEy2VnBw2dlyb7l6FsWzskeIaQjeaKHbHT/exec";

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const submitBtn = document.getElementById("submitBtn");
  const resetBtn = document.getElementById("resetBtn");
  const statusText = document.getElementById("statusText");
  const playback = document.getElementById("playback");

  const nameEl = document.getElementById("name");
  const yearEl = document.getElementById("year");
  const emailEl = document.getElementById("email");
  const phoneEl = document.getElementById("phone");
  const subjectEl = document.getElementById("subject");

  let mediaRecorder = null;
  let chunks = [];
  let audioBlob = null;
  let audioUrl = null;
  let isSubmitting = false;

  function setStatus(text){
    statusText.textContent = text;
  }

  function cleanupUrl(){
    if (audioUrl){
      URL.revokeObjectURL(audioUrl);
      audioUrl = null;
    }
  }

  function resetAll(){
    if (isSubmitting) return;

    try{
      if (mediaRecorder && mediaRecorder.state !== "inactive"){
        mediaRecorder.stop();
      }
    }catch(e){}

    mediaRecorder = null;
    chunks = [];
    audioBlob = null;
    cleanupUrl();
    playback.src = "";

    startBtn.disabled = false;
    stopBtn.disabled = true;
    submitBtn.disabled = true;
    resetBtn.disabled = true;

    setStatus("Ready");
  }

  function safeText(v){
    return String(v || "").trim();
  }

  function makeFilename(){
    const now = new Date().toISOString().replace(/[:.]/g, "").slice(0, 15);
    const n = safeText(nameEl.value).replace(/[^a-z0-9]+/gi, "_").slice(0, 30) || "Anonymous";
    const y = safeText(yearEl.value).replace(/[^0-9]+/g, "").slice(0, 4);
    const s = safeText(subjectEl.value).replace(/[^a-z0-9]+/gi, "_").slice(0, 40) || "Story";
    const parts = ["Classof88", s, n];
    if (y) parts.push(y);
    parts.push(now);
    return parts.join("_") + ".webm";
  }

  function blobToBase64(blob){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error("Failed to read audio data."));
      reader.onload = () => {
        const result = String(reader.result || "");
        const comma = result.indexOf(",");
        if (comma === -1) return reject(new Error("Invalid base64 data."));
        resolve(result.slice(comma + 1));
      };
      reader.readAsDataURL(blob);
    });
  }

  startBtn.addEventListener("click", async () => {
    try{
      resetAll();

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert("This browser does not support microphone recording.");
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });

      chunks = [];
      audioBlob = null;

      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(chunks, { type: "audio/webm" });
        cleanupUrl();
        audioUrl = URL.createObjectURL(audioBlob);
        playback.src = audioUrl;

        submitBtn.disabled = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        resetBtn.disabled = false;

        setStatus("Ready to submit");
        stream.getTracks().forEach(t => t.stop());
      };

      mediaRecorder.start();

      startBtn.disabled = true;
      stopBtn.disabled = false;
      submitBtn.disabled = true;
      resetBtn.disabled = false;

      setStatus("Recording");
    }catch(err){
      alert("Microphone access failed. Allow mic permissions and try again.");
      resetAll();
    }
  });

  stopBtn.addEventListener("click", () => {
    if (mediaRecorder && mediaRecorder.state === "recording"){
      setStatus("Stopping");
      mediaRecorder.stop();
    }
  });

  submitBtn.addEventListener("click", async () => {
    if (!audioBlob) return;

    try{
      isSubmitting = true;
      startBtn.disabled = true;
      stopBtn.disabled = true;
      submitBtn.disabled = true;
      resetBtn.disabled = true;

      setStatus("Preparing submission");

      const base64 = await blobToBase64(audioBlob);
      const filename = makeFilename();

      const payload = {
        filename: filename,
        mimeType: "audio/webm",
        data: base64,
        name: safeText(nameEl.value),
        year: safeText(yearEl.value),
        email: safeText(emailEl.value),
        phone: safeText(phoneEl.value),
        subject: safeText(subjectEl.value)
      };

      setStatus("Submitting");

      await fetch(UPLOAD_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
      });

      setStatus("Submitted. Thank you.");
      resetBtn.disabled = false;
    }catch(err){
      setStatus("Submit failed");
      alert("Submit failed. " + String(err));
      submitBtn.disabled = false;
      resetBtn.disabled = false;
    }finally{
      isSubmitting = false;
      startBtn.disabled = false;
    }
  });

  resetBtn.addEventListener("click", resetAll);
  window.addEventListener("beforeunload", cleanupUrl);
</script>

</body>
</html>
